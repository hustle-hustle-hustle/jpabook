## 10.3 Criteria

- Criteria 쿼리는 JPQL을 자바 코드로 작성하도록 도와주는 빌더 클래스이다.
- Criteria를 사용하면 문자가 아닌 코드로 JPQL을 작성하므로 문법 오류를 컴파일 단계에서 잡을 수 있고, JPQL 보다 동적 쿼리를 안전하게 생성할 수 있다
- 하지만 개발하다보면 코드가 복잡하고 장황해서 직관적으로 이해하기 힘들다는 단점도 있다.

```java
// JPQL: select m from Membmer m

CriteriaBuilder cb = em.getCriteriaBuilder(); // 쿼리 빌더

CriteriaQuery<Member> cq = cb.createQuery(Member.class); // Criteria 생성, 반환 타입 지정

Root<Member> m  = cq.from(Member.class); // FROM

Predicate userNameEqual = cb.eqaul(m.get("username"), "john"); // 검색 조건

java.persistence.criteria.Order ageDesc = cb.desc(m.get("age")); // 정렬

cq.select(m)
    .where(userNameEqual)
    .orderBy(ageDesc); // SELECT

TypedQuery<Member> query = em.createQuery(cq);
List<Member> members = query.getResultList();
```

- Criteria 는 코드로 JPQL을 완성하는 도구다. 따라서 경로 표현식도 있다.
    - m.get("username") 은  JPQL 의  m.username 이다.
    - m.get("team").get("name") 은 m.team.name 과 같다.

- 반환 타입을 지정할 수 없거나 반환 타입이 둘 이상이면 타입을 지정하지 않고 Object 로 반환받으면 된다
```java
CriteriaBuilder cb = em.getCriteriaBuilder(); // 쿼리 빌더
CriteriaQuery<Object> cq = cb.createQuery(); // Criteria 생성, 반환 

// 반환 타입이 둘 이상이면
CriteriaQuery<Object[]> cq = cb.createQuery(Object[].class); // Criteria 생성, 반환 

```

- 조회 대상을 한건, 여러건 지정
```java 
cq.select(m); // 한건
cq.multiselect(m.get("username"), m.get("age")); // 여러건
cq.multiselect(m.get("username"), m.get("age")).distinct(true); // 여러건, Distict
```

- New, contruct()
```java
// JPQL: select new MemberDTO(m.username, m.age)
// from Member m
CriteriaQuery<MemberDTO> cq = cb.createQuery(MemberDTO.class); 
Root<Member> m = cq.from(Member.class);

cq.select(cb.contruct(MemberDTO.class, m.get("username"), m.get("age"));
TypedQuery<MemberDTO> query = em.createQuery(cq);
List<MemberDTO> resultList = query.getResultList();
```

- Tuple
```java
// JPQL: select m.username, m.age from Member m

CriteriaBuilder cb = em.getCriteriaBuilder();

CriteriaQuery<Tuple> cq = cb.createTupleQuery();

Root<Member> m = cq.from(Member.class);
cq.multiselect(
    m.get("username").alias("username"), // 튜플에서 사용할 튜플 별칭 
    m,get("age").alias("age")
);

TypedQuery<Tuple> query = em.createQuery(cq);
List<Tuple> resultList = query.getResultList();
for (Tuple tuple : resultList) {
    String username = tuple.get("username", String.class);
}
```

- Group

```
cq ...
cq.groupBy(m.get("team").get("name"));
```

- Having

```
cq.multiselect(m.get("team").get("name"), maxAge, minAge)
    .groupBy(m.get("team").get("name"))
    .having(cb.gt(minAge, 10)); // Having
```

- Sort

```
cb.desc(...);

cq.select(m).orderBy(cb.desc(m.get("age")));
```

- Join

조인은 join() 메소드와 JoinType 클래스를 사용한다.

```java
/* JPQL
select m,t from Member m 
inner join m.team 
where t.name = 'foo'
*/

Root<Member> m = cq.from(Member.class);
Join<Member, Team> t = m.join("team", JoinType.INNER);

cq.multiselect(m, t)
    .where(cb.equal(t.get("name"), "foo"));

// m.join("team") 은 이너 조인이다.
// m.join("team", JoinType.LEFT); 외부 조인이다

// Fetch join
Root<Member> m = cq.from(Member.class);
m.fetch("team", JoinType.LEFT);
cq.select(m);
```

- Subquery
```java
/*
JPQL:
    select m from Member m
    where m.age >= (select AVG(m2.age) from Member m2)
*/

CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> mainQUery = cb.createQuery(Member.class);

Subquery<Double> subQuery = mainQuery.subquery(Double.class);
Root<Member> m2 = subQuery.from(Member.class);
subQuery.select(cb.avg(m2.<Integer>get("age")));

Root<Member> m = mainQuery.from(Member.class);
mainQuery.select(m).where(ch.ge(m.<Intenger>get("age"), subQuery));
```

- In
```java
/*
    JPQL
    select m from Member m
    where m.username in ("Foo", "Bar")
*/

cq.select(m).where(
    cb.in(m.get("username")).value("Foo").value("Bar")
)
```

- Parameter
```java
/*
JPQL
    select m from Member m
    where m.username = :usernameParam
*/

cq.select(m)
    .where(cb.equal(m.get("username"), cb.parameter(String.calss, "usernameParam")));

List<Member> resultList = em.createQuery(cq)
    .setParameter("username", "foo").getResultList();
```

- Native
```java
Expression<Long> function = cb.function("SUM", Long.class, m.get("age"));
cq.select(function); 
```

